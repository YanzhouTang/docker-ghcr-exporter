name: Sync Neura-Dev to Aliyun ACR

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  workflow_run:
    workflows: ["Build Neura-Dev Docker Image"]
    types:
      - completed

jobs:
  sync-image:
    # åªåœ¨æ„å»ºæˆåŠŸåè¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Aliyun Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.DOCKER_REGISTRY_CN }}
          username: ${{ secrets.DOCKER_USERNAME_CN }}
          password: ${{ secrets.DOCKER_PASSWORD_CN }}

      - name: Pull, Tag, and Push Docker Image
        run: |
          # å®šä¹‰æºé•œåƒå’Œç›®æ ‡é•œåƒ
          SOURCE_IMAGE="ghcr.io/${{ github.repository_owner }}/neura-dev:latest"
          TARGET_IMAGE="${{ secrets.DOCKER_REGISTRY_CN }}/enzotang/neura-dev:latest"

          # ä»GHCRæ‹‰å–é•œåƒ
          echo "ğŸ“¥ Pulling image from GHCR: $SOURCE_IMAGE"
          docker pull $SOURCE_IMAGE

          # é‡æ–°æ‰“æ ‡ç­¾
          echo "ğŸ·ï¸  Tagging image for Aliyun ACR: $TARGET_IMAGE"
          docker tag $SOURCE_IMAGE $TARGET_IMAGE

          # æ¨é€åˆ°é˜¿é‡Œäº‘ACR
          echo "ğŸ“¤ Pushing image to Aliyun ACR: $TARGET_IMAGE"
          docker push $TARGET_IMAGE

          echo ""
          echo "âœ… Image synced successfully!"
          echo "You can now pull from node3 using:"
          echo "  docker pull $TARGET_IMAGE"
